# Demonstrate how to use Hermes with hdf5_iotest

## Build Hermes
```bash
git clone https://github.com/jya-kmu/hdf5.git
git checkout kimmy/c_wrapper
git checkout 3d7fd686cefa27d72520f5521afa574332ffc306 .
```
build with `HERMES_ENABLE_WRAPPER=ON`

## Build hdf5 with Hermes VFD
```bash
git checkout https://github.com/jya-kmu/hdf5.git
git checkout hermes_vfd
git checkout 30d224cec2ea21c41ce09083f96885ea4785bbdf .
```
build hdf5 with `HDF5_ENABLE_PARALLEL=ON` and `HDF5_ENABLE_HERMES_VFD=ON`

## Build hdf5-iotest
```bash
git checkout https://github.com/jya-kmu/hdf5-iotest.git
git checkout hermes-vfd
```
Then copy hermes.conf file (i.e 1MB/1MB_RAM_NVME_BB/16KB_1MB_random/hermes.conf)
to top hdf5-iotest directory, and edit file `src/hdf5_iotest.ini` to decide
if split metadata and data (`split = 1`) or not or not (`split = 0`).

In file `src/hdf5_iotest.c` the last parameter in 
`status = H5Pset_fapl_hermes(fapl, false, 1048576)` (@line 176)
sets up the page size for both metadata and data (if `split = 0`) or data page size 
(if `split = 1`). Default parameter 1048576 indicates 1MiB page size.
We provide two VFD methods for metadata if it is different from raw data. The first  
method is hermes VFD. The last parameter in
`status = H5Pset_fapl_hermes(fapl_m, false, 4096)` (@line 333)
sets up the page size for metadata (if `split = 1`). User can modify these parameter
for performance test. The second methods is core VFD, which keeps the metadata in
memory by the HDF5 API `status = H5Pset_fapl_core(fapl_m, (size_t)0, 0)`.

## Config with Hermes
The `hermes.conf` file is used for Hermes environment setup. We provide examples for tests
using 4KiB page size (in 4KB directory) and 1Mib Page size (in 1MB directory) separately.
In each of the directory they are further catigarized into not split metadata and data
test (1MB/128KB_NoSplit), and split metadata and data test (4/8/16KB_128KB/1MB). Each of 
the them can test with "random" and "round-robin" data placement stratage, provided in the
examples with name suffix.
User can modify `mount_points` and `swap_mount` in the file according to the
executing system configuration.

Set up Herems environment variables by
```bash
export HERMES_CONF=/path/to/hermes.conf
```

## Run
Run the test as
```bash
GLOG_minloglevel=2 /path/to/hdf5_iotest /path/to/hdf5_iotest.ini
```

## Run with Darshan
Darshan output can be generated by running the command
```bash
LD_PRELOAD=/path/to/libdarshan.so GLOG_minloglevel=2 /path/to/hdf5_iotest /path/to/hdf5_iotest.ini
```

## Plot result with Gnuplot
The file with ".plot" suffix is the file that could be used to plot the result in ".txt" file, by
```
cd "/path/to/result"
load "*.plot"
```
