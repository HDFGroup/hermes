# Demonstrate how to use Hermes with hdf5_iotest

## Build Hermes

Follow the instructions in the Hermes
[README](https://github.com/HDFGroup/hermes#hermes). Make sure to set the following options:
* `HERMES_ENABLE_VFD=ON`
* `HERMES_ENABLE_WRAPPER=ON`

## Build hdf5-iotest

### Dependencies

* parallel HDF5

We use a fork of `hdf5-iotest` with a few modifications to make it compatible
with with the Hermes VFD.

```bash
git clone https://github.com/jya-kmu/hdf5-iotest.git
cd hdf5-iotest
git checkout hermes-vfd
```
We need two config files `hermes.yaml` and `hdf5_iotest.ini` to start `hdf5-iotest` with 
Hermes buffering system. 

To create hermes.yaml configuration file for Hermes environment setup, user can start from
the provided example hermes.yaml (named `hermes.conf_4KB_128KB_example`) and modify it 
to match different system setup and test purposes. For example, user can modify 
`mount_points` and `swap_mount` in the config file according to the system configuration.
Once the file is ready, place it to top hdf5-iotest directory.

User also needs the file `src/hdf5_iotest.ini` to start hdf5_iotest. For our test we
only modify the `split` option if to split metadata and data (`split = 1`) 
or not (`split = 0`). An example `hdf5_iotest.ini` file is also provided in this
direcotry without splitting metadata and data.

If the user choose not to split metadata and data by setting `split = 0`, the page
size is the same for metadata and data (if choosing hermes) and can be setup by function 
`status = H5Pset_fapl_hermes(fapl, false, 1048576)` (@line 176) in file 
`src/hdf5_iotest.c`. The last parameter in the function is the page size 1MiB in
this example. User can modify it for performance test.

If the user choose to split metadata and data by setting `split = 1`, they
can use different VFD methods or same VFD method with different parameter 
configuration for metadata and data. In the example of hdf5-iotest, function 
`status = H5Pset_fapl_hermes(fapl, false, 1048576)` (@line 176) in file
`src/hdf5_iotest.c` will setup the page size for data. And default in this test
we choose HDF5 core VFD for metadata by HDF5 API
`status = H5Pset_fapl_core(fapl_m, (size_t)0, 0)` (@line 334), which will keep
the metadata in memory. As another option, user can choose Hermes VFD for
metadata with a smaller
page size by `status = H5Pset_fapl_hermes(fapl_m, false, 4096)` (@line 333) 
instead of core VFD.

We provide the performance results in hdf5-iotest_Hermes_VFD.csv for splitting and 
not splitting metadata and data, and further using different methods for metadata
in the splitting case.

## Before the run
Set up Herems environment variables by
```bash
export HERMES_CONF=/path/to/hermes.yaml
```

## Run
Run the test as
```bash
GLOG_minloglevel=2 /path/to/hdf5_iotest /path/to/hdf5_iotest.ini
```

## Run with Darshan
Darshan output can be generated by running the command
```bash
LD_PRELOAD=/path/to/libdarshan.so GLOG_minloglevel=2 /path/to/hdf5_iotest /path/to/hdf5_iotest.ini
```
