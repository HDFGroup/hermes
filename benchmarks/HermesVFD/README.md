# Demonstrate how to use Hermes with hdf5_iotest

## Build Hermes
```bash
git clone https://github.com/HDFGroup/hermes.git
```
build with `HERMES_ENABLE_WRAPPER=ON` following the instructions in hermes README file

## Build hdf5 with Hermes VFD
```bash
git clone https://github.com/jya-kmu/hdf5.git
git checkout hermes_vfd
git checkout 30d224cec2ea21c41ce09083f96885ea4785bbdf .
```
build hdf5 with `HDF5_ENABLE_PARALLEL=ON` and `HDF5_ENABLE_HERMES_VFD=ON`

## Build hdf5-iotest
```bash
git checkout https://github.com/jya-kmu/hdf5-iotest.git
git checkout hermes-vfd
```
Then generate hermes.conf file by ./gen_config with config parameters and
place to top hdf5-iotest directory. We provide hermes.conf sample file, named
`hermes.conf_sample`, and associated command to run with it in different directories
for hdf5_iotest according to different configurations.

User also needs the file `src/hdf5_iotest.ini` to config hdf5_iotest. For our test we
only modify the `split` option if to split metadata and data (`split = 1`) 
or not (`split = 0`).

If the user choose not to split metadata and data by setting `split = 0`, the page
size is the same for metadata and data and can be setup by function 
`status = H5Pset_fapl_hermes(fapl, false, 1048576)` (@line 176) in file 
`src/hdf5_iotest.c`. The last parameter in the function is the page size 1MiB in
this example. Use can modify it for performance test.

If the user choose to split metadata and data by setting `split = 1`, they
can use different VFD methods or same VFD method with different parameter 
configuration for metadata and data. In the example of hdf5-iotest, function 
`status = H5Pset_fapl_hermes(fapl, false, 1048576)` (@line 176) in file
`src/hdf5_iotest.c` will setup the page size for data. And default in this test
we choose HDF5 core VFD for metadata by HDF5 API
`status = H5Pset_fapl_core(fapl_m, (size_t)0, 0)` (@line 334), which will keep
the metadata in memory. User can choose Hermes VFD for metadata with a smaller
page size by `status = H5Pset_fapl_hermes(fapl_m, false, 4096)` (@line 333) 
instead of core VFD.

We provide the performance results in hdf5-iotest_Hermes_VFD.csv for splitting and 
not splitting metadata and data, and further using different methods for metadata
in the splitting case.

## Config with Hermes
The file `hermes.conf` is used for Hermes environment setup. We provide examples for tests
using 128KiB page size (in 128KB directory) and 1Mib Page size (in 1MB directory) separately.
In each of the directory they are further catigarized into not splitting metadata and data
test (1MB/128KB_NoSplit), and splitting metadata and data test (1/4/8/16KB_128KB/1MB). Each
of them can run with "random" and "round-robin" data placement stratage, provided in the
examples with name suffix.
User can modify `mount_points` and `swap_mount` in the file according to the
executing system configuration.

Set up Herems environment variables by
```bash
export HERMES_CONF=/path/to/hermes.conf
```

## Run
Run the test as
```bash
GLOG_minloglevel=2 /path/to/hdf5_iotest /path/to/hdf5_iotest.ini
```

## Run with Darshan
Darshan output can be generated by running the command
```bash
LD_PRELOAD=/path/to/libdarshan.so GLOG_minloglevel=2 /path/to/hdf5_iotest /path/to/hdf5_iotest.ini
```

## Plot result with Gnuplot
The file with ".plot" suffix is the file that could be used to plot the result in ".txt" file, by
```
cd "/path/to/result"
load "*.plot"
```
